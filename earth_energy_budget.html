<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>지구 열수지 인터랙티브 활동</title>
  <style>
    :root{--bg:#0b1220;--card:#ffffff;--muted:#6b7280;--accent:#2563eb;--good:#059669;--bad:#dc2626}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;background:#f3f4f6;color:#111827}
    header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid #e5e7eb;padding:12px 16px;z-index:10}
    h1{margin:0;font-size:20px}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.04);padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .row-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    @media (max-width:960px){.row,.row-3{grid-template-columns:1fr}}
    img.hero{width:100%;height:auto;border-radius:12px;border:1px solid #e5e7eb}
    label{font-weight:600;font-size:14px}
    input[type="number"], input[type="text"], select{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;font-size:14px}
    input[type="range"]{width:100%}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1118270d;color:#111827;border:1px solid #e5e7eb}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#11182708;border:1px solid #e5e7eb;color:#374151;font-size:12px}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #e5e7eb;padding:8px 10px;text-align:left}
    .ok{color:var(--good);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .metric{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .metric h4{margin:0 0 6px 0;font-size:13px;color:#6b7280}
    .metric .value{font-size:22px;font-weight:800}
    .muted{color:#6b7280}
    .footer{color:#6b7280;font-size:13px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid2{grid-template-columns:1fr}}
    .spacer{height:6px}
  </style>
</head>
<body>
  <header>
    <h1>🌍 지구 열수지 인터랙티브 활동</h1>
  </header>

  <main>
    <!-- 이미지 섹션 -->
    <section class="card">
      <div class="row">
        <div>
          <img id="diagram" class="hero" src="지구 열수지.png" alt="태양·지구 복사 에너지 다이어그램" />
          <div class="spacer"></div>
          <div class="grid2">
            <div>
              <label for="imgUrl">이미지 경로/URL (선택)</label>
              <input id="imgUrl" type="text" placeholder="예: images/diagram.png 또는 https://..." />
            </div>
            <div style="display:flex;gap:8px;align-items:flex-end;">
              <button class="btn secondary" id="applyImg">이미지 변경</button>
              <span class="muted">기본값: 같은 폴더의 <b>지구 열수지.png</b></span>
            </div>
          </div>
        </div>
        <div>
          <p><span class="pill">가정</span> 모든 값은 <b>상대값</b>입니다. (태양 복사 에너지 = 100)</p>
          <div class="card" style="padding:12px">
            <label for="blankCount">빈칸 개수: <span id="blankCountLabel">6</span>개</label>
            <input id="blankCount" type="range" min="3" max="13" value="6" />
            <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn" id="reshuffle">🔄 새 빈칸 뽑기</button>
              <button class="btn secondary" id="fillAllCorrect">정답 자동 채우기</button>
              <button class="btn secondary" id="clearBlanks">빈칸만 비우기</button>
            </div>
            <p class="muted" style="margin-top:8px">※ GitHub Pages에 올릴 경우, 이 HTML과 이미지 파일을 같은 폴더에 두세요.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 입력 폼 -->
    <section class="card">
      <h2 style="margin-top:0">① 값 채우기</h2>
      <div id="inputs" class="row"></div>
    </section>

    <!-- 채점/결과 -->
    <section class="card">
      <h2 style="margin-top:0">② 채점 결과</h2>
      <div id="scoreSummary" class="muted"></div>
      <div class="spacer"></div>
      <div style="overflow:auto">
        <table id="scoreTable">
          <thead>
            <tr>
              <th>항목</th>
              <th>입력값</th>
              <th>정답</th>
              <th>결과</th>
              <th>오차(입력-정답)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 열수지 계산 -->
    <section class="card">
      <h2 style="margin-top:0">③ 열수지 확인 (입력값 기준)</h2>
      <div class="row">
        <div>
          <h3 style="margin:0 0 8px 0">(A) 대기권 상단 TOA</h3>
          <div class="grid2">
            <div class="metric"><h4>들어옴(태양)</h4><div class="value" id="toaIn">-</div></div>
            <div class="metric"><h4>나감(반사+복사)</h4><div class="value" id="toaOut">-</div></div>
            <div class="metric"><h4>수지(들어옴-나감)</h4><div class="value" id="toaBal">-</div></div>
          </div>
          <p class="muted" id="toaMsg"></p>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0">(B) 지표</h3>
          <div class="grid2">
            <div class="metric"><h4>입력(흡수+재복사)</h4><div class="value" id="surfIn">-</div></div>
            <div class="metric"><h4>출력(복사+잠열+감열)</h4><div class="value" id="surfOut">-</div></div>
            <div class="metric"><h4>수지(입력-출력)</h4><div class="value" id="surfBal">-</div></div>
          </div>
          <p class="muted">참고: 자료마다 <em>대기창(12)</em> 처리 등이 달라 수치 차이가 있을 수 있습니다. 목적은 <b>관계 이해와 계산 연습</b>입니다.</p>
        </div>
      </div>
    </section>

    <!-- 내보내기 -->
    <section class="card">
      <h2 style="margin-top:0">④ 활동지 내보내기</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn secondary" id="downloadWS">📝 활동지 CSV</button>
        <button class="btn secondary" id="downloadKey">✅ 정답지 CSV</button>
      </div>
    </section>

    <p class="footer">© 2025 • CC-BY 교육용. 이 페이지는 클라이언트 사이드만 사용하므로 GitHub Pages에서 그대로 작동합니다.</p>
  </main>

  <script>
    // ===== 정답 마스터 =====
    const ANSWER_KEY = {
      S_in: { label: "태양 복사 에너지 (들어옴)", value: 100 },
      albedo_total: { label: "지구의 반사(전체)", value: 30 },
      albedo_low: { label: "대기/구름/대기권 반사", value: 25 },
      albedo_surface: { label: "지표에서의 반사", value: 5 },
      S_abs_surface: { label: "지표면 흡수(태양복사)", value: 50 },
      S_abs_atm: { label: "대기와 구름의 흡수(태양복사)", value: 20 },
      L_out_space: { label: "우주로 나가는 지구 복사", value: 70 },
      L_emit_atm_to_space: { label: "대기와 구름의 방출(우주로)", value: 58 },
      L_emit_surface: { label: "지표면 복사(상향)", value: 102 },
      L_window: { label: "대기 창을 통해 직접 우주로(지표에서)", value: 12 },
      L_back: { label: "대기의 재복사(하향)", value: 94 },
      H: { label: "대류와 전도(감열, 상향)", value: 7 },
      LE: { label: "물의 증발(잠열, 상향)", value: 23 }
    };
    const ALL_KEYS = Object.keys(ANSWER_KEY);

    // ===== 상태 =====
    let blanks = [];

    // 유틸
    function randInt(n){ return Math.floor(Math.random()*n); }
    function sample(arr, k){
      const copy = [...arr];
      const out = [];
      for(let i=0;i<k && copy.length>0;i++){
        const idx = randInt(copy.length);
        out.push(copy[idx]);
        copy.splice(idx,1);
      }
      return out;
    }
    function numberOrNull(v){ const x = parseFloat(v); return Number.isFinite(x)? x : null; }

    // UI 요소
    const inputsDiv = document.getElementById('inputs');
    const blankCount = document.getElementById('blankCount');
    const blankCountLabel = document.getElementById('blankCountLabel');

    // 이미지 적용
    document.getElementById('applyImg').addEventListener('click', ()=>{
      const url = document.getElementById('imgUrl').value.trim();
      if(url) document.getElementById('diagram').src = url;
    });

    // 빈칸 설정
    function chooseBlanks(){
      const n = parseInt(blankCount.value,10);
      blanks = sample(ALL_KEYS, n);
    }

    function createInput(label, key){
      const wrap = document.createElement('div');
      const lab = document.createElement('label'); lab.textContent = label; lab.htmlFor = `inp_${key}`; wrap.appendChild(lab);
      const inp = document.createElement('input');
      inp.type = 'number'; inp.step = 'any'; inp.id = `inp_${key}`; inp.placeholder = blanks.includes(key)? '(빈칸)' : '';
      inp.value = blanks.includes(key)? '' : ANSWER_KEY[key].value;
      inp.addEventListener('input', updateAll);
      wrap.appendChild(inp);
      return wrap;
    }

    function renderInputs(){
      inputsDiv.innerHTML = '';
      const half = Math.ceil(ALL_KEYS.length/2);
      const left = document.createElement('div'); left.className = 'card';
      const right = document.createElement('div'); right.className = 'card';
      const leftFrag = document.createElement('div'); leftFrag.className='grid2';
      const rightFrag = document.createElement('div'); rightFrag.className='grid2';
      ALL_KEYS.forEach((k, i)=>{
        const el = createInput(ANSWER_KEY[k].label, k);
        (i<half? leftFrag : rightFrag).appendChild(el);
      });
      left.appendChild(leftFrag); right.appendChild(rightFrag);
      inputsDiv.appendChild(left); inputsDiv.appendChild(right);
    }

    // 채점/계산
    function readInputs(){
      const out = {};
      ALL_KEYS.forEach(k=>{
        const el = document.getElementById(`inp_${k}`);
        out[k] = el? numberOrNull(el.value) : null;
        if(out[k]===null && !blanks.includes(k)){
          // 빈칸이 아니면 정답 기본값 사용
          out[k] = ANSWER_KEY[k].value;
        }
      });
      return out;
    }

    function buildScoreTable(values){
      const tbody = document.querySelector('#scoreTable tbody');
      tbody.innerHTML = '';
      let correct = 0;
      ALL_KEYS.forEach(k=>{
        const tr = document.createElement('tr');
        const truth = ANSWER_KEY[k].value;
        const user = values[k];
        const ok = (user!==null) && Math.abs(user - truth) < 1e-9;
        if(ok) correct++;
        const diff = (user===null)? '' : (ok? '' : (user - truth));
        tr.innerHTML = `
          <td>${ANSWER_KEY[k].label}</td>
          <td>${user===null? '<span class="muted">미입력</span>' : user}</td>
          <td>${truth}</td>
          <td class="${ok? 'ok':'bad'}">${ok? '정답':'오답'}</td>
          <td>${diff}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('scoreSummary').innerHTML = `✅ 정답 개수: <b>${correct}</b> / ${ALL_KEYS.length}`;
    }

    function updateBalances(values){
      const S_in = values.S_in ?? ANSWER_KEY.S_in.value;
      const albedo_total = values.albedo_total ?? ANSWER_KEY.albedo_total.value;
      const L_out_space = values.L_out_space ?? ANSWER_KEY.L_out_space.value;

      const S_abs_surface = values.S_abs_surface ?? ANSWER_KEY.S_abs_surface.value;
      const L_back = values.L_back ?? ANSWER_KEY.L_back.value;
      const L_emit_surface = values.L_emit_surface ?? ANSWER_KEY.L_emit_surface.value;
      const LE = values.LE ?? ANSWER_KEY.LE.value;
      const H = values.H ?? ANSWER_KEY.H.value;

      const toa_in = S_in;
      const toa_out = albedo_total + L_out_space;
      const toa_balance = toa_in - toa_out;

      const surface_in = S_abs_surface + L_back;
      const surface_out = L_emit_surface + LE + H;
      const surface_balance = surface_in - surface_out;

      const f = (x)=> Number.isFinite(x)? x.toFixed(0) : '-';
      document.getElementById('toaIn').textContent = f(toa_in);
      document.getElementById('toaOut').textContent = f(toa_out);
      document.getElementById('toaBal').textContent = f(toa_balance);
      document.getElementById('surfIn').textContent = f(surface_in);
      document.getElementById('surfOut').textContent = f(surface_out);
      document.getElementById('surfBal').textContent = f(surface_balance);

      const toaMsg = (Math.abs(toa_balance) < 1e-9) ?
        'TOA 수지가 0이므로 행성 규모에서 평형입니다.' : 'TOA 수지가 0이 아닙니다. 값을 다시 확인해 보세요.';
      document.getElementById('toaMsg').textContent = toaMsg;
    }

    function updateAll(){
      const vals = readInputs();
      buildScoreTable(vals);
      updateBalances(vals);
    }

    // 다운로드 (CSV)
    function toCSV(rows){
      const esc = s => '"' + String(s).replaceAll('"','""') + '"';
      if(rows.length===0) return '';
      const keys = Object.keys(rows[0]);
      const head = keys.map(esc).join(',');
      const body = rows.map(r => keys.map(k=>esc(r[k])).join(',')).join('\n');
      return head + '\n' + body;
    }

    function downloadBlob(filename, text){
      const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    document.getElementById('downloadWS').addEventListener('click', ()=>{
      const wsRows = blanks.map(k=> ({ '항목키': k, '항목라벨': ANSWER_KEY[k].label, '정답(비워두세요)': '' }));
      downloadBlob('열수지_활동지.csv', toCSV(wsRows));
    });
    document.getElementById('downloadKey').addEventListener('click', ()=>{
      const keyRows = blanks.map(k=> ({ '항목키': k, '항목라벨': ANSWER_KEY[k].label, '정답': ANSWER_KEY[k].value }));
      downloadBlob('열수지_정답지.csv', toCSV(keyRows));
    });

    // 버튼들
    document.getElementById('reshuffle').addEventListener('click', ()=>{ chooseBlanks(); renderInputs(); updateAll(); });
    document.getElementById('fillAllCorrect').addEventListener('click', ()=>{
      ALL_KEYS.forEach(k=>{ const el = document.getElementById(`inp_${k}`); if(el) el.value = ANSWER_KEY[k].value; });
      updateAll();
    });
    document.getElementById('clearBlanks').addEventListener('click', ()=>{
      blanks.forEach(k=>{ const el = document.getElementById(`inp_${k}`); if(el) el.value = ''; });
      updateAll();
    });

    // 초기화
    blankCount.addEventListener('input', ()=>{ blankCountLabel.textContent = blankCount.value; });
    blankCountLabel.textContent = blankCount.value;
    chooseBlanks();
    renderInputs();
    updateAll();
  </script>
</body>
</html>
